generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

//////////////////////////////////
// USERS & ACCESS CONTROL
//////////////////////////////////

model User {
  id           String   @id @default(uuid())
  name         String
  phone        String   @unique
  email        String   @unique
  password     String
  language     String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())

  roles        UserRole[]
  addresses    UserAddress[]

  restaurantsOwned   Restaurant[] @relation("OwnerRestaurants")
  restaurantManaged  Restaurant?  @relation("AdminRestaurant")

  foodOrders   FoodOrder[]
  deliveryDriver DeliveryDriver?
  shippingAgent ShippingAgent?

  shippingOrders ShippingOrder[]
  chatParticipants ChatParticipant[]
  chatMessages     ChatMessage[]

  favoritesRestaurants FavoriteRestaurant[]
  favoritesProducts    FavoriteProduct[]

  ratings       Rating[]
  tickets       SupportTicket[]
  payments      Payment[]
  activityLogs  ActivityLog[]
  couponUsages  CouponUsage[]
  userPoints    UserPoints?
  pointsTransactions PointsTransaction[]
  cart          Cart?
  orderStatusHistory OrderStatusHistory[]
  notifications Notification[]
  paymentMethods PaymentMethod[]

  @@index([email])
  @@index([phone])
}

model Role {
  id    Int    @id @default(autoincrement())
  name  String @unique

  users UserRole[]

  @@index([name])
}

model UserRole {
  userId String
  roleId Int

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
}

model UserAddress {
  id          String   @id @default(uuid())
  userId      String
  type        String?  // 'home', 'work', 'office', 'other'
  label       String?  // e.g., "شقة", "مكتب"
  address     String
  lat         Float
  lng         Float
  phone       String?  // Optional phone for this address
  building    String?
  floor       String?
  apartment   String?
  notes       String?  @db.Text
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isDefault])
  @@index([type])
}

//////////////////////////////////
// RESTAURANTS & PRODUCTS
//////////////////////////////////

model Category {
  id        String  @id @default(uuid())
  nameAr    String
  nameEn    String
  type      String
  imageUrl  String?
  isActive  Boolean @default(true)

  restaurants Restaurant[]

  @@index([type])
  @@index([isActive])
}

model Restaurant {
  id            String   @id @default(uuid())
  categoryId    String
  ownerId       String
  adminId       String?  @unique
  imageUrl      String?

  nameAr        String
  nameEn        String
  descriptionAr String?  @db.Text
  descriptionEn String?  @db.Text
  phone         String
  deliveryType  String
  rating        Float    @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())

  category Category @relation(fields: [categoryId], references: [id])
  owner    User     @relation("OwnerRestaurants", fields: [ownerId], references: [id])
  admin    User?    @relation("AdminRestaurant", fields: [adminId], references: [id])

  subcategories  Subcategory[]
  products       Product[]
  foodOrders     FoodOrder[]
  promotions     Promotion[]
  coupons        Coupon[]
  deliveryDrivers DeliveryDriver[]
  favorites      FavoriteRestaurant[]
  hours          RestaurantHours[]
  deliveryZones  DeliveryZone[]
  deliveryTimeEstimate DeliveryTimeEstimate?

  @@index([categoryId])
  @@index([ownerId])
  @@index([isActive])
}

model Subcategory {
  id           String  @id @default(uuid())
  restaurantId String
  nameAr       String
  nameEn       String
  isActive     Boolean @default(true)

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  products   Product[]

  @@index([restaurantId])
}

model Product {
  id            String  @id @default(uuid())
  restaurantId  String
  subcategoryId String
  nameAr        String
  nameEn        String
  descriptionAr String? @db.Text
  descriptionEn String? @db.Text
  price         Float
  calories      Int?
  cookingTime   Int?    // Cooking time in minutes (e.g., 15-20)
  nutritionInfo Json?   // Extended nutrition information (e.g., {protein: 20g, carbs: 50g, fat: 10g})
  rating        Float   @default(0)
  isAvailable   Boolean @default(true)

  restaurant  Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  subcategory Subcategory @relation(fields: [subcategoryId], references: [id])

  options        ProductOption[]
  orderItems     FoodOrderItem[]
  promotionLinks PromotionProduct[]
  favoriteBy     FavoriteProduct[]
  images         ProductImage[]
  cartItems      CartItem[]

  @@index([restaurantId])
  @@index([subcategoryId])
  @@index([isAvailable])
}

model ProductOption {
  id        String  @id @default(uuid())
  productId String
  nameAr    String
  nameEn    String
  price     Float
  isActive  Boolean @default(true)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

//////////////////////////////////
// FOOD DELIVERY
//////////////////////////////////

model OrderStatusHistory {
  id          String   @id @default(uuid())
  orderId     String
  status      String
  userId      String?  // Who changed the status
  notes       String?  @db.Text
  expectedAt  DateTime? // Expected completion time
  createdAt   DateTime @default(now())

  order FoodOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user  User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([status])
  @@index([createdAt])
}

model DeliveryDriver {
  id               String  @id @default(uuid())
  userId           String  @unique
  restaurantId     String?
  isPlatformDriver Boolean
  isOnline         Boolean @default(false)
  rating           Float   @default(0)

  user       User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  restaurant Restaurant?    @relation(fields: [restaurantId], references: [id])
  orders     FoodOrder[]
  location   DriverLocation?

  @@index([userId])
  @@index([restaurantId])
  @@index([isOnline])
}

//////////////////////////////////
// DRIVER LOCATION
//////////////////////////////////

model DriverLocation {
  id        String   @id @default(uuid())
  driverId  String   @unique
  lat       Float
  lng       Float
  heading   Float?   // Compass heading in degrees
  speed     Float?   // Speed in km/h
  updatedAt DateTime @updatedAt

  driver DeliveryDriver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([driverId])
  @@index([updatedAt])
}

model FoodOrder {
  id           String   @id @default(uuid())
  userId       String
  restaurantId String
  driverId     String?
  addressId    String
  status       String
  totalPrice   Float
  tip          Float?
  notes        String?  @db.Text
  cancelledAt   DateTime?
  cancelReason  String?
  cancelledBy   String?  // 'customer', 'restaurant', 'admin'
  createdAt    DateTime @default(now())

  user       User            @relation(fields: [userId], references: [id])
  restaurant Restaurant      @relation(fields: [restaurantId], references: [id])
  driver     DeliveryDriver? @relation(fields: [driverId], references: [id])

  items   FoodOrderItem[]
  chat    Chat?
  coupons CouponUsage[]
  pointsTransactions PointsTransaction[]
  statusHistory OrderStatusHistory[]
  notifications Notification[]

  @@index([userId])
  @@index([restaurantId])
  @@index([driverId])
  @@index([status])
  @@index([createdAt])
  @@index([cancelledAt])
}

model FoodOrderItem {
  id          String @id @default(uuid())
  foodOrderId String
  productId   String
  quantity    Int
  price       Float

  order   FoodOrder @relation(fields: [foodOrderId], references: [id], onDelete: Cascade)
  product Product   @relation(fields: [productId], references: [id])

  @@index([foodOrderId])
  @@index([productId])
}

//////////////////////////////////
// SHIPPING
//////////////////////////////////

model ShippingAgent {
  id          String  @id @default(uuid())
  userId      String  @unique
  vehicleType String
  isActive    Boolean @default(true)
  rating      Float   @default(0)

  user   User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders ShippingOrder[]

  @@index([userId])
  @@index([isActive])
}

model ShippingOrder {
  id           String   @id @default(uuid())
  userId       String
  agentId      String?
  pickupLat    Float
  pickupLng    Float
  deliveryLat  Float
  deliveryLng  Float
  status       String
  expectedCost Float
  finalCost    Float?
  createdAt    DateTime @default(now())

  user  User           @relation(fields: [userId], references: [id])
  agent ShippingAgent? @relation(fields: [agentId], references: [id])

  images ShippingOrderImage[]
  chat   Chat?

  @@index([userId])
  @@index([agentId])
  @@index([status])
  @@index([createdAt])
}

model ShippingOrderImage {
  id              String @id @default(uuid())
  shippingOrderId String
  imageUrl        String

  order ShippingOrder @relation(fields: [shippingOrderId], references: [id], onDelete: Cascade)

  @@index([shippingOrderId])
}

//////////////////////////////////
// CHAT SYSTEM
//////////////////////////////////

model Chat {
  id        String   @id @default(uuid())
  orderType String
  foodOrderId     String? @unique
  shippingOrderId String? @unique
  createdAt DateTime @default(now())

  foodOrder     FoodOrder?     @relation(fields: [foodOrderId], references: [id], onDelete: Cascade)
  shippingOrder ShippingOrder? @relation(fields: [shippingOrderId], references: [id], onDelete: Cascade)

  participants ChatParticipant[]
  messages     ChatMessage[]

  @@index([orderType])
}

model ChatParticipant {
  id     String @id @default(uuid())
  chatId String
  userId String
  role   String

  chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([chatId, userId])
  @@index([chatId])
  @@index([userId])
}

model ChatMessage {
  id        String   @id @default(uuid())
  chatId    String
  senderId  String
  message   String   @db.Text
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  chat   Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)
  sender User @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([chatId])
  @@index([senderId])
  @@index([createdAt])
}

//////////////////////////////////
// PROMOTIONS & COUPONS
//////////////////////////////////

model Promotion {
  id            String   @id @default(uuid())
  restaurantId  String
  type          String
  discountType  String
  discountValue Float
  startAt       DateTime
  endAt         DateTime
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())

  restaurant Restaurant         @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  products   PromotionProduct[]

  @@index([restaurantId])
  @@index([isActive])
  @@index([startAt, endAt])
}

model PromotionProduct {
  id          String @id @default(uuid())
  promotionId String
  productId   String

  promotion Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([promotionId, productId])
}
  
model Coupon {
  id             String   @id @default(uuid())
  restaurantId   String
  code           String   @unique
  discountType   String
  discountValue  Float
  minOrderAmount Float
  usageLimit     Int
  usedCount      Int      @default(0)
  startAt        DateTime
  endAt          DateTime
  isActive       Boolean  @default(true)

  restaurant Restaurant    @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  usages     CouponUsage[]

  @@index([restaurantId])
  @@index([code])
  @@index([isActive])
}

model CouponUsage {
  id       String   @id @default(uuid())
  couponId String
  userId   String
  orderId  String
  usedAt   DateTime @default(now())

  coupon Coupon    @relation(fields: [couponId], references: [id], onDelete: Cascade)
  user   User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  order  FoodOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@unique([couponId, userId, orderId])
  @@index([couponId])
  @@index([userId])
}

//////////////////////////////////
// SOCIAL / SUPPORT / PAYMENTS
//////////////////////////////////

model FavoriteRestaurant {
  id           String   @id @default(uuid())
  userId       String
  restaurantId String
  createdAt    DateTime @default(now())

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([userId, restaurantId])
  @@index([userId])
  @@index([restaurantId])
}

model FavoriteProduct {
  id        String   @id @default(uuid())
  userId    String
  productId String
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
}

model Rating {
  id         String   @id @default(uuid())
  userId     String
  targetType String
  targetId   String
  rating     Int
  comment    String?  @db.Text
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([targetType, targetId])
  @@index([rating])
}

model SupportTicket {
  id        String   @id @default(uuid())
  userId    String
  orderType String
  orderId   String
  status    String
  message   String   @db.Text
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model Payment {
  id        String   @id @default(uuid())
  userId    String
  orderType String
  orderId   String
  amount    Float
  method    String
  status    String
  paymentMethodId String? // Reference to saved payment method
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([orderType, orderId])
  @@index([status])
  @@index([paymentMethodId])
}

//////////////////////////////////
// NOTIFICATIONS
//////////////////////////////////

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String   // 'order', 'status', 'promotion', 'system', 'payment'
  title     String
  message   String   @db.Text
  data      Json?    // Additional data
  isRead    Boolean  @default(false)
  orderId   String?  // Related order if applicable
  createdAt DateTime @default(now())

  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  order FoodOrder? @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@index([createdAt])
  @@index([orderId])
}

//////////////////////////////////
// PAYMENT METHODS
//////////////////////////////////

model PaymentMethod {
  id          String   @id @default(uuid())
  userId      String
  type        String   // 'card', 'wallet', 'cash', 'google_pay', 'k_net'
  provider    String?  // 'visa', 'mastercard', 'google_pay', 'k_net'
  last4       String?  // Last 4 digits for cards
  expiryMonth Int?
  expiryYear  Int?
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isDefault])
  @@index([type])
}

model ActivityLog {
  id         String   @id @default(uuid())
  userId     String
  action     String
  entityType String
  entityId   String
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
}

//////////////////////////////////
// PRODUCT IMAGES
//////////////////////////////////

model ProductImage {
  id        String   @id @default(uuid())
  productId String
  imageUrl  String
  isPrimary Boolean  @default(false)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([isPrimary])
}

//////////////////////////////////
// SPLASH SCREENS
//////////////////////////////////

model SplashScreen {
  id        String   @id @default(uuid())
  image     String
  duration  Int      @default(3000) // milliseconds
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([sortOrder])
}

//////////////////////////////////
// ONBOARDING SCREENS
//////////////////////////////////

model OnboardingScreen {
  id          String   @id @default(uuid())
  title       String
  titleAr     String?
  description String   @db.Text
  descriptionAr String? @db.Text
  image       String
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@index([sortOrder])
}

//////////////////////////////////
// CONTENT PAGES
//////////////////////////////////

model PrivacyPolicy {
  id        String   @id @default(uuid())
  contentEn String   @db.Text
  contentAr String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TermsOfService {
  id        String   @id @default(uuid())
  contentEn String   @db.Text
  contentAr String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AboutApp {
  id            String   @id @default(uuid())
  titleEn       String?
  titleAr       String?
  descriptionEn String?  @db.Text
  descriptionAr String?  @db.Text
  version       String?
  imageEn       String?
  imageAr       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

//////////////////////////////////
// POINTS & REWARDS SYSTEM
//////////////////////////////////

model UserPoints {
  id           String   @id @default(uuid())
  userId       String   @unique
  points       Int      @default(0)
  earnedPoints Int      @default(0)
  usedPoints   Int      @default(0)
  expiresAt    DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model PointsTransaction {
  id          String    @id @default(uuid())
  userId      String
  orderId     String?
  points      Int
  type        String    // 'earned', 'used', 'expired', 'reward', 'bonus'
  description String?   @db.Text
  createdAt   DateTime  @default(now())

  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  order FoodOrder? @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([orderId])
  @@index([type])
  @@index([createdAt])
}

//////////////////////////////////
// DELIVERY ZONES
//////////////////////////////////

model DeliveryZone {
  id          String   @id @default(uuid())
  restaurantId String
  name        String
  coordinates Json     // Polygon coordinates [{lat, lng}, ...]
  isActive    Boolean  @default(true)
  fee         Float?   // Delivery fee for this zone
  minOrder    Float?   // Minimum order for this zone
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([isActive])
}

//////////////////////////////////
// DELIVERY TIME ESTIMATION
//////////////////////////////////

model DeliveryTimeEstimate {
  id            String   @id @default(uuid())
  restaurantId  String   @unique
  baseTime      Int      // Base minutes
  perKmTime     Int?     // Additional minutes per km
  busyTimeAdd   Int?     // Additional minutes during busy hours
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
}

//////////////////////////////////
// RESTAURANT HOURS
//////////////////////////////////

model RestaurantHours {
  id          String   @id @default(uuid())
  restaurantId String
  dayOfWeek   Int      // 0-6 (Sunday-Saturday)
  openTime    String   // e.g., "09:00"
  closeTime   String   // e.g., "22:00"
  isOpen      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([restaurantId, dayOfWeek])
  @@index([restaurantId])
  @@index([dayOfWeek])
}

//////////////////////////////////
// SHOPPING CART
//////////////////////////////////

model Cart {
  id        String    @id @default(uuid())
  userId    String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  user  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CartItem[]

  @@index([userId])
}

model CartItem {
  id        String   @id @default(uuid())
  cartId    String
  productId String
  quantity  Int      @default(1)
  options   Json?    // Selected product options
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([cartId, productId])
  @@index([cartId])
  @@index([productId])
}
